#!/bin/bash

source .fonctions	# Charge les fonctions génériques habituellement utilisées dans le script

# Récupère les infos de l'application.
app=$YNH_APP_INSTANCE_NAME

# Source app helpers
source /usr/share/yunohost/helpers

domain=$(ynh_app_setting_get $app domain)
path=$(ynh_app_setting_get $app path)
final_path=$(ynh_app_setting_get $app final_path)

CHECK_PATH	# Vérifie et corrige la syntaxe du path.

SETUP_SOURCE "teampass.tar.gz"	# Télécharge la source, décompresse et copie dans $final_path

# Delete the install directory.
SECURE_REMOVE '$final_path/install'

# Et copie le fichier de config nginx
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/$app.conf

# Modifie les variables dans le fichier de configuration nginx
sudo sed -i "s@__PATH__@$path@g" /etc/nginx/conf.d/$domain.d/$app.conf
sudo sed -i "s@__FINALPATH__@$final_path@g" /etc/nginx/conf.d/$domain.d/$app.conf
sudo sed -i "s@__NAMETOCHANGE__@$app@g" /etc/nginx/conf.d/$domain.d/$app.conf

ADD_SYS_USER	# Créer un user système dédié pour l'application
POOL_FPM	# Créer le fichier de configuration du pool php-fpm et le configure.

# sudo chown www-data: -R $final_path
# sudo chmod 770 -R $final_path
# sudo find $final_path -type f -print0 | xargs -0 sudo chmod 740		# Applique les permissions sur les fichiers seulement (rwxr-----)
# sudo chmod 770 -R $final_path/files $final_path/upload
# sudo chmod a+x $final_path/CsvToXml_For_Teampass.sh

# -rw-r--r-- sur les fichiers
sudo find $final_path -type f -print0 | xargs -0 sudo chmod 644
# drwxr-xr-x sur les dossiers
sudo find $final_path -type d -print0 | xargs -0 sudo chmod 755
# Les dossiers files et upload ont besoin d'un droit d'écriture.
sudo chmod 774 -R $final_path/files $final_path/upload
# Le script de conversion csv xml doit être exécutable, au moins par root.
sudo chmod 744 $final_path/CsvToXml_For_Teampass.sh
# Les fichiers appartiennent à root
sudo chown -R root: $final_path

# Recharge la configuration Nginx
sudo service nginx reload
# Régénère la configuration de SSOwat
sudo yunohost app ssowatconf
